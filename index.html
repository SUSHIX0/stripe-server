<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Магазин с количеством и скидками</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .product { margin-bottom: 10px; }
    .cart { margin-top: 20px; }
    button { padding: 5px 10px; margin-left: 10px; }
    input[type=number] { width: 50px; }
    .cart-item { margin-bottom: 5px; }
    select { margin-left: 5px; }
  </style>
</head>
<body>
  <h1>Магазин с количеством и скидками</h1>

  <div class="products">
    <div class="product">
      <span>Товар A — 5 €</span>
      <input type="number" min="1" value="1" id="qtyA">
      <button onclick="addToCart('Товар A', 5, 'qtyA')">Добавить</button>
    </div>
    <div class="product">
      <span>Товар B — 8 €</span>
      <input type="number" min="1" value="1" id="qtyB">
      <button onclick="addToCart('Товар B', 8, 'qtyB')">Добавить</button>
    </div>

    <div class="product">
      <span>Промокод:</span>
      <select id="discountType">
        <option value="percent">Процент (%)</option>
        <option value="fixed">Фикс (€)</option>
      </select>
      <input type="number" min="1" value="10" id="discountValue">
      <button onclick="applyPromo()">Применить</button>
    </div>
  </div>

  <div class="cart">
    <h2>Корзина</h2>
    <ul id="cartItems"></ul>
    <p id="total">Итого: 0 €</p>
    <button id="pay">Перейти к оплате</button>
  </div>

  <script>
    const cart = [];
    let discountType = null;
    let discountValue = 0;

    function addToCart(name, price, qtyId) {
      const qty = parseInt(document.getElementById(qtyId).value);
      if (!qty || qty <= 0) {
        alert("Введите корректное количество");
        return;
      }

      const existing = cart.find(item => item.name === name);
      if (existing) {
        existing.quantity += qty;
      } else {
        cart.push({ name, price, quantity: qty });
      }

      renderCart();
    }

    function applyPromo() {
      const typeSelect = document.getElementById('discountType');
      const valueInput = document.getElementById('discountValue');

      discountType = typeSelect.value;
      discountValue = parseFloat(valueInput.value);

      if (!discountValue || discountValue <= 0) {
        alert("Введите корректное значение скидки");
        discountType = null;
        discountValue = 0;
        return;
      }

      alert(`Скидка ${discountValue}${discountType === 'percent' ? '%' : ' €'} будет применена к корзине`);
      renderCart();
    }

    function renderCart() {
      const list = document.getElementById('cartItems');
      const totalEl = document.getElementById('total');
      list.innerHTML = '';
      let total = 0;

      cart.forEach(item => {
        const li = document.createElement('li');
        li.className = 'cart-item';
        li.textContent = `${item.name} — ${item.price} € × ${item.quantity} = ${item.price * item.quantity} €`;
        list.appendChild(li);
        total += item.price * item.quantity;
      });

      if (discountType && discountValue > 0) {
        if (discountType === 'percent') {
          total = total * (1 - discountValue / 100);
        } else if (discountType === 'fixed') {
          total = total - discountValue;
        }
        if (total < 0) total = 0;
      }

      totalEl.textContent = `Итого: ${total.toFixed(2)} €`;
    }

    document.getElementById("pay").onclick = async () => {
      if (cart.length === 0) {
        alert("Корзина пуста!");
        return;
      }

      const cartForServer = cart.map(item => ({
        name: item.name,
        unitPrice: item.price,
        qty: item.quantity
      }));

      try {
        const response = await fetch("http://localhost:4242/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            cart: cartForServer, 
            discount: { type: discountType, value: discountValue } 
          })
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert("Ошибка создания платежа");
        }
      } catch (err) {
        alert("Ошибка запроса к серверу: " + err.message);
      }
    };
  </script>
</body>
</html>
